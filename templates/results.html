{% extends "base.html" %}

{% block title %}Röntgen Sonuçları{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <h1 class="mt-4">Analiz Sonucu</h1>
    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item"><a href="{% url 'index' %}">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="{% url 'upload' %}">Röntgen Yükle</a></li>
        <li class="breadcrumb-item active">Analiz Sonucu</li>
    </ol>

    <div class="row">
        <!-- SOL: XRAY + CANVAS -->
        <div class="col-xl-6">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-x-ray me-1"></i> Analizli Röntgen
                </div>
                <div class="card-body text-center">

                    {% if xray and xray.image %}
                    <div class="position-relative d-inline-block">
                        <img id="xrayImage"
                             src="{{ xray.image.url }}"
                             class="img-fluid rounded shadow"
                             style="max-height:420px;"
                             alt="Röntgen">

                        <canvas id="bboxCanvas"
                                class="position-absolute top-0 start-0"></canvas>
                    </div>

                    <p class="text-muted mt-2">
                        <small>Kutuların üzerine gelerek detayları görebilirsiniz.</small>
                    </p>
                    {% else %}
                        <p>Röntgen görüntüsü bulunamadı.</p>
                    {% endif %}

                    {% if xray %}
                        <p class="mb-0"><strong>Kullanıcı:</strong> {{ xray.user.username }}</p>
                        <p class="mb-0"><strong>Durum:</strong> {{ xray.status }}</p>
                        <p class="text-muted mb-0">
                            <small>{{ xray.created_at|date:"d.m.Y H:i" }}</small>
                        </p>
                        {% if xray.notes %}
                            <p class="mt-2 mb-0"><strong>Not:</strong> {{ xray.notes }}</p>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- SAĞ: TABLO -->
        <div class="col-xl-6">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-notes-medical me-1"></i> Tespit Edilen Bulgular
                </div>
                <div class="card-body">
                    {% if predictions %}
                    <table class="table table-sm table-bordered align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>Hastalık</th>
                                <th>Güven (%)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for p in predictions %}
                            <tr
                                {% if p.label == "Caries" %} style="background:rgba(220,53,69,0.15);"
                                {% elif p.label == "Filling" %} style="background:rgba(13,110,253,0.15);"
                                {% elif p.label == "Crown - bridge" %} style="background:rgba(111,66,193,0.15);"
                                {% elif p.label == "Implant" %} style="background:rgba(25,135,84,0.15);"
                                {% elif p.label == "Post-screw" %} style="background:rgba(255,193,7,0.18);"
                                {% elif p.label == "Root Canal Obturation" %} style="background:rgba(253,126,20,0.18);"
                                {% endif %}
                            >
                                <td>{{ forloop.counter }}</td>
                                <td>{{ p.label }}</td>
                                <td>{{ p.score|floatformat:2 }}%</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                        <p>Bu röntgen için henüz sonuç yok.</p>
                    {% endif %}
                </div>
            </div>

            <div class="d-flex justify-content-between">
                <a href="{% url 'upload' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i> Yeni Röntgen Yükle
                </a>
                <a href="{% url 'results_pdf' xray.id %}" class="btn btn-danger">
                    <i class="fas fa-file-pdf me-1"></i> PDF Rapor İndir
                </a>
                <a href="{% url 'tables' %}" class="btn btn-primary">
                    <i class="fas fa-list me-1"></i> Tüm Analizleri Gör
                </a>
            </div>
        </div>
    </div>

    <!-- LEGEND -->
    <div class="card mt-4">
        <div class="card-header">
            <i class="fas fa-palette me-1"></i> Renk Açıklamaları
        </div>
        <div class="card-body">
            <div class="row gy-2">
                <div class="col-md-4"><span class="badge me-2" style="background:#dc3545;">&nbsp;</span> Caries</div>
                <div class="col-md-4"><span class="badge me-2" style="background:#0d6efd;">&nbsp;</span> Filling</div>
                <div class="col-md-4"><span class="badge me-2" style="background:#6f42c1;">&nbsp;</span> Crown / Bridge</div>
                <div class="col-md-4"><span class="badge me-2" style="background:#198754;">&nbsp;</span> Implant</div>
                <div class="col-md-4"><span class="badge me-2" style="background:#ffc107;">&nbsp;</span> Post-screw</div>
                <div class="col-md-4"><span class="badge me-2" style="background:#fd7e14;">&nbsp;</span> Root Canal</div>
            </div>
        </div>
    </div>
</div>

<!-- TOOLTIP -->
<div id="bboxTooltip"
     style="position:absolute; display:none; z-index:9999;
            background:#fff; border:1px solid #ddd;
            padding:6px 10px; border-radius:6px; font-size:13px;">
</div>

<script>
const predictions = [
{% for p in predictions %}
{
    label: "{{ p.label }}",
    score: {{ p.score }},
    x1: {{ p.x1 }}, y1: {{ p.y1 }},
    x2: {{ p.x2 }}, y2: {{ p.y2 }}
},
{% endfor %}
];

const COLORS = {
    "Caries": "rgba(220,53,69,1)",
    "Filling": "rgba(13,110,253,1)",
    "Crown - bridge": "rgba(111,66,193,1)",
    "Implant": "rgba(25,135,84,1)",
    "Post-screw": "rgba(255,193,7,1)",
    "Root Canal Obturation": "rgba(253,126,20,1)"
};

const img = document.getElementById("xrayImage");
const canvas = document.getElementById("bboxCanvas");
const ctx = canvas.getContext("2d");
const tooltip = document.getElementById("bboxTooltip");

img.onload = () => {
    canvas.width = img.clientWidth;
    canvas.height = img.clientHeight;
    drawBoxes();
};

function drawBoxes(highlight=null){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    predictions.forEach((p,i)=>{
        const sx = canvas.width / img.naturalWidth;
        const sy = canvas.height / img.naturalHeight;
        const x = p.x1 * sx, y = p.y1 * sy;
        const w = (p.x2-p.x1)*sx, h=(p.y2-p.y1)*sy;
        ctx.lineWidth = highlight===i ? 4 : 2;
        ctx.strokeStyle = COLORS[p.label] || "lime";
        ctx.strokeRect(x,y,w,h);
    });
}

canvas.addEventListener("mousemove", e=>{
    const r = canvas.getBoundingClientRect();
    const mx = e.clientX - r.left;
    const my = e.clientY - r.top;
    let found=false;

    predictions.forEach((p,i)=>{
        const sx = canvas.width / img.naturalWidth;
        const sy = canvas.height / img.naturalHeight;
        const x = p.x1 * sx, y = p.y1 * sy;
        const w = (p.x2-p.x1)*sx, h=(p.y2-p.y1)*sy;

        if(mx>=x && mx<=x+w && my>=y && my<=y+h){
            found=true;
            drawBoxes(i);
            tooltip.style.display="block";
            tooltip.style.left=e.pageX+10+"px";
            tooltip.style.top=e.pageY+10+"px";
            tooltip.innerHTML=`<b>${p.label}</b><br>Güven: %${(p.score<=1?p.score*100:p.score).toFixed(1)}`;
        }
    });

    if(!found){
        drawBoxes();
        tooltip.style.display="none";
    }
});
</script>
{% endblock %}
